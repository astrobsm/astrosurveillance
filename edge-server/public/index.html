<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ASTROSURVEILLANCE - Surveillance Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1a1a2e;
      --primary-light: #16213e;
      --accent: #e94560;
      --accent-light: #ff6b6b;
      --background: #0f0f1a;
      --surface: #1a1a2e;
      --surface-light: #252542;
      --text-primary: #ffffff;
      --text-secondary: #b8b8d1;
      --text-muted: #6c6c8a;
      --success: #00d26a;
      --warning: #ffc107;
      --danger: #ff4757;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      min-height: 100vh;
      color: var(--text-primary);
    }

    /* Header */
    .header {
      background: var(--surface);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--surface-light);
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .connection-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface-light);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      color: var(--success);
    }

    .connection-dot {
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main Container */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Alarm Card */
    .alarm-card {
      background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .alarm-card.safe {
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
    }

    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes borderPulse {
      0%, 100% { box-shadow: inset 0 0 20px rgba(255, 71, 87, 0.3); }
      50% { box-shadow: inset 0 0 40px rgba(255, 71, 87, 0.6); }
    }

    .alarm-card.flashing {
      animation: flash 0.5s infinite, borderPulse 0.5s infinite;
    }

    .alarm-info {
      flex: 1;
    }

    .alarm-status {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      margin-bottom: 4px;
    }

    .alarm-title {
      font-size: 32px;
      font-weight: 700;
      color: white;
    }

    .alarm-icon {
      font-size: 64px;
      color: rgba(255,255,255,0.3);
      margin: 0 32px;
    }

    .alarm-actions {
      display: flex;
      gap: 12px;
    }

    .alarm-btn {
      padding: 14px 28px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .alarm-btn.trigger {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .alarm-btn.stop {
      background: white;
      color: var(--danger);
    }

    .alarm-btn:hover {
      transform: scale(1.05);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .stat-icon.cameras { background: rgba(233, 69, 96, 0.2); color: var(--accent); }
    .stat-icon.recordings { background: rgba(0, 210, 106, 0.2); color: var(--success); }
    .stat-icon.storage { background: rgba(255, 193, 7, 0.2); color: var(--warning); }
    .stat-icon.uptime { background: rgba(108, 108, 138, 0.2); color: var(--text-secondary); }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Two Column Layout */
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }

    /* Section */
    .section {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-link {
      font-size: 14px;
      color: var(--accent);
      cursor: pointer;
    }

    /* Camera List */
    .camera-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .camera-card {
      background: var(--surface-light);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .camera-preview {
      width: 80px;
      height: 60px;
      background: var(--background);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 24px;
    }

    .camera-info {
      flex: 1;
    }

    .camera-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .camera-location {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .camera-status {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 12px;
    }

    .camera-status.online { color: var(--success); }
    .camera-status.recording { color: var(--accent); }

    .camera-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Events List */
    .events-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .event-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--surface-light);
      border-radius: 12px;
    }

    .event-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .event-icon.motion { background: rgba(233, 69, 96, 0.2); color: var(--accent); }
    .event-icon.recording { background: rgba(0, 210, 106, 0.2); color: var(--success); }

    .event-info {
      flex: 1;
    }

    .event-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .event-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .action-btn {
      flex: 1;
      padding: 14px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--surface-light);
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--accent);
      color: white;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.hidden { display: none; }
    .modal-content {
      background: var(--surface);
      padding: 32px;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
    }
    .modal-content h3 {
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 20px;
    }
    .modal-content p {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 16px;
    }
    .modal-content input {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid var(--surface-light);
      background: var(--background);
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 16px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
    }
    .modal-buttons button {
      flex: 1;
      padding: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .modal-buttons button:first-child {
      background: var(--surface-light);
      color: var(--text-secondary);
    }
    .modal-buttons button.primary {
      background: var(--accent);
      color: white;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <div class="header-title">ASTROSURVEILLANCE</div>
      <div class="header-subtitle">Bonnesante Medicals - Edge Server</div>
    </div>
    <div class="connection-badge" id="connection-badge">
      <div class="connection-dot"></div>
      Connected
    </div>
  </div>

  <div class="main-container">
    <!-- Alarm Card -->
    <div class="alarm-card safe" id="alarm-card">
      <div class="alarm-info">
        <div class="alarm-status">System Status</div>
        <div class="alarm-title" id="alarm-title">All Clear</div>
      </div>
      <i class="mdi mdi-shield-check alarm-icon" id="alarm-icon"></i>
      <div class="alarm-actions">
        <button class="alarm-btn trigger" onclick="triggerAlarm()">
          <i class="mdi mdi-alarm-light"></i>
          Test Alarm
        </button>
        <button class="alarm-btn stop" onclick="stopAlarm()">
          <i class="mdi mdi-stop"></i>
          Stop
        </button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon cameras">
          <i class="mdi mdi-cctv"></i>
        </div>
        <div class="stat-value" id="stat-cameras">0</div>
        <div class="stat-label">Cameras Online</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon recordings">
          <i class="mdi mdi-filmstrip"></i>
        </div>
        <div class="stat-value" id="stat-recordings">0</div>
        <div class="stat-label">Recordings</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon storage">
          <i class="mdi mdi-harddisk"></i>
        </div>
        <div class="stat-value" id="stat-storage">0%</div>
        <div class="stat-label">Storage Used</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon uptime">
          <i class="mdi mdi-clock-outline"></i>
        </div>
        <div class="stat-value" id="stat-uptime">0m</div>
        <div class="stat-label">Uptime</div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="two-column">
      <!-- Cameras Section -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Cameras</div>
          <span class="section-link" id="cameras-count">0 cameras</span>
        </div>
        <div class="camera-list" id="camera-list">
          <div class="camera-card">
            <div class="camera-preview">
              <i class="mdi mdi-cctv"></i>
            </div>
            <div class="camera-info">
              <div class="camera-name">No Cameras</div>
              <div class="camera-location">Use discovery or add manually</div>
              <div class="camera-status">
                <div class="camera-status-dot"></div>
                Waiting...
              </div>
            </div>
          </div>
        </div>
        <div class="action-buttons">
          <button class="action-btn" onclick="openWiFiSetupModal()">
            <i class="mdi mdi-wifi"></i> WiFi Setup
          </button>
          <button class="action-btn" onclick="openBarcodeScannerModal()">
            <i class="mdi mdi-barcode-scan"></i> Scan
          </button>
          <button class="action-btn" onclick="openQRPairModal()">
            <i class="mdi mdi-qrcode"></i> QR Pair
          </button>
          <button class="action-btn" onclick="discoverCameras()">
            <i class="mdi mdi-magnify"></i> Discover
          </button>
        </div>
      </div>

      <!-- Events Section -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">Recent Events</div>
          <span class="section-link">View All</span>
        </div>
        <div class="events-list" id="events-list">
          <div class="event-item">
            <div class="event-icon recording">
              <i class="mdi mdi-check"></i>
            </div>
            <div class="event-info">
              <div class="event-title">System Started</div>
              <div class="event-time">Just now</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scan Modal -->
  <div id="scan-modal" class="modal hidden">
    <div class="modal-content">
      <h3><i class="mdi mdi-qrcode-scan"></i> Add Camera</h3>
      <p>Enter camera details or paste barcode data.</p>
      
      <div style="margin-bottom: 12px;">
        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Camera IP Address *</label>
        <input type="text" id="cam-ip" placeholder="192.168.1.100">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Username</label>
          <input type="text" id="cam-user" placeholder="admin">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Password</label>
          <input type="password" id="cam-pass" placeholder="password">
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Camera Name</label>
          <input type="text" id="cam-name" placeholder="Factory Entrance">
        </div>
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Location</label>
          <input type="text" id="cam-location" placeholder="Building A">
        </div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Or paste barcode data:</label>
        <input type="text" id="scan-data-input" placeholder='{"ip":"192.168.1.100","username":"admin"...}'>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeScanModal()">Cancel</button>
        <button class="primary" onclick="addScannedCamera()">
          <i class="mdi mdi-plus"></i> Add Camera
        </button>
      </div>
    </div>
  </div>

  <!-- Barcode Scanner Modal -->
  <div id="barcode-scanner-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
      <h3><i class="mdi mdi-barcode-scan"></i> Scan Camera Barcode</h3>
      <p>Use your device camera to scan the barcode/QR code on your GZ-SONY MAKE.BELIEVE camera.</p>
      
      <!-- Camera Video Feed -->
      <div id="scanner-container" style="margin: 16px 0; border-radius: 12px; overflow: hidden; background: #000; position: relative;">
        <video id="barcode-video" style="width: 100%; display: block;" autoplay playsinline muted></video>
        <div id="scanner-line" style="position: absolute; top: 50%; left: 10%; width: 80%; height: 2px; background: var(--accent); box-shadow: 0 0 10px var(--accent); animation: scanLine 2s infinite;"></div>
        <div id="scanner-overlay" class="hidden" style="text-align: center; padding: 60px 20px; color: var(--text-muted); position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--surface-light);">
          <i class="mdi mdi-camera-off" style="font-size: 48px;"></i>
          <p style="margin-top: 12px;">Camera access not available</p>
          <p style="font-size: 12px;">Please allow camera access or enter data manually below</p>
        </div>
      </div>
      
      <style>
        @keyframes scanLine {
          0%, 100% { top: 30%; opacity: 1; }
          50% { top: 70%; opacity: 0.5; }
        }
      </style>
      
      <!-- Scanner Status -->
      <div id="barcode-status" style="text-align: center; padding: 12px; background: var(--surface-light); border-radius: 8px; margin-bottom: 12px;">
        <i class="mdi mdi-barcode-scan" style="margin-right: 8px;"></i>
        <span id="barcode-status-text">Position barcode within the frame</span>
      </div>
      
      <!-- Detected Data Display -->
      <div id="detected-data" class="hidden" style="margin-bottom: 12px; padding: 12px; background: var(--background); border-radius: 8px; border: 2px solid var(--success);">
        <div style="font-size: 12px; color: var(--success); margin-bottom: 4px;"><i class="mdi mdi-check-circle"></i> Barcode Detected!</div>
        <code id="detected-data-text" style="font-size: 11px; word-break: break-all; color: var(--text-secondary);"></code>
      </div>
      
      <!-- Manual Input Fallback -->
      <div style="margin-top: 12px;">
        <div style="text-align: center; color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">â€” OR ENTER MANUALLY â€”</div>
        <input type="text" id="barcode-manual-input" placeholder="Paste barcode data or camera info here..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--surface-light); background: var(--background); color: var(--text-primary); font-family: monospace; font-size: 12px;">
      </div>
      
      <!-- Supported Formats -->
      <div style="margin-top: 12px; padding: 12px; background: var(--background); border-radius: 8px; font-size: 11px; color: var(--text-muted);">
        <strong>Supported formats:</strong>
        <ul style="margin: 4px 0 0 16px; padding: 0;">
          <li>QR/JSON: {"ip":"...","user":"...","pass":"..."}</li>
          <li>RTSP URL: rtsp://user:pass@192.168.1.100/stream</li>
          <li>Simple: 192.168.1.100:554:admin:password</li>
        </ul>
      </div>
      
      <div class="modal-buttons" style="margin-top: 16px;">
        <button onclick="closeBarcodeScannerModal()">Cancel</button>
        <button class="primary" onclick="addBarcodeCamera()">
          <i class="mdi mdi-plus"></i> Add Camera
        </button>
      </div>
    </div>
  </div>

  <!-- QR Pairing Modal -->
  <div id="qr-pair-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px; text-align: center;">
      <h3><i class="mdi mdi-qrcode"></i> QR Code Pairing</h3>
      <p>Point your camera at this QR code to automatically pair it.</p>
      
      <!-- Camera Name/Location Input -->
      <div id="qr-input-section">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; text-align: left;">
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Camera Name</label>
            <input type="text" id="qr-cam-name" placeholder="Factory Entrance">
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Location</label>
            <input type="text" id="qr-cam-location" placeholder="Building A">
          </div>
        </div>
        <button class="action-btn" style="width: 100%; background: var(--accent); color: white;" onclick="generatePairingQR()">
          <i class="mdi mdi-qrcode"></i> Generate QR Code
        </button>
      </div>
      
      <!-- QR Code Display -->
      <div id="qr-display-section" class="hidden" style="margin-top: 16px;">
        <div id="qr-code-container" style="background: white; padding: 20px; border-radius: 12px; display: inline-block; margin-bottom: 16px;">
          <img id="qr-code-img" style="width: 280px; height: 280px;" alt="Pairing QR Code">
        </div>
        
        <div id="qr-status" style="padding: 12px; background: var(--surface-light); border-radius: 8px; margin-bottom: 16px;">
          <i class="mdi mdi-loading mdi-spin" style="margin-right: 8px;"></i>
          <span id="qr-status-text">Waiting for camera to scan...</span>
        </div>
        
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
          <strong>Instructions:</strong><br>
          1. Display this QR code on your screen<br>
          2. Point your ONVIF camera at the screen<br>
          3. The server will detect the camera viewing this code<br>
          4. Camera will be automatically paired
        </div>
        
        <div id="qr-timer" style="font-size: 14px; color: var(--warning); margin-bottom: 12px;">
          Expires in: <span id="qr-countdown">5:00</span>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button onclick="closeQRPairModal()">Close</button>
        <button class="primary hidden" id="qr-regenerate-btn" onclick="regeneratePairingQR()">
          <i class="mdi mdi-refresh"></i> Generate New
        </button>
      </div>
    </div>
  </div>

  <!-- WiFi Setup Modal -->
  <div id="wifi-setup-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 550px;">
      <h3><i class="mdi mdi-wifi"></i> WiFi Camera Setup</h3>
      <p>Connect your GZ-SONY MAKE.BELIEVE camera to your WiFi network.</p>
      
      <!-- Step Indicator -->
      <div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0;">
        <div class="wifi-step active" id="wifi-step-1">
          <span>1</span>
          <small>Connect</small>
        </div>
        <div class="wifi-step-line"></div>
        <div class="wifi-step" id="wifi-step-2">
          <span>2</span>
          <small>Configure</small>
        </div>
        <div class="wifi-step-line"></div>
        <div class="wifi-step" id="wifi-step-3">
          <span>3</span>
          <small>Complete</small>
        </div>
      </div>
      
      <style>
        .wifi-step {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
        }
        .wifi-step span {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background: var(--surface-light);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          color: var(--text-muted);
        }
        .wifi-step.active span {
          background: var(--accent);
          color: white;
        }
        .wifi-step.completed span {
          background: var(--success);
          color: white;
        }
        .wifi-step small {
          font-size: 10px;
          color: var(--text-muted);
        }
        .wifi-step-line {
          flex: 1;
          height: 2px;
          background: var(--surface-light);
          margin-top: 16px;
        }
      </style>
      
      <!-- Step 1: Connect to Camera's WiFi -->
      <div id="wifi-panel-1">
        <div style="background: var(--surface-light); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <h4 style="color: var(--accent); margin-bottom: 12px;"><i class="mdi mdi-access-point"></i> Step 1: Connect to Camera's WiFi</h4>
          <ol style="color: var(--text-secondary); font-size: 14px; padding-left: 20px; line-height: 1.8;">
            <li>Power on your GZ-SONY camera</li>
            <li>Wait for the camera's WiFi LED to blink</li>
            <li>On your device, go to WiFi settings</li>
            <li>Connect to: <strong style="color: var(--warning);">GZ-SONY-XXXXXX</strong></li>
            <li>Default password: <strong style="color: var(--warning);">12345678</strong></li>
            <li>Return here once connected</li>
          </ol>
        </div>
        
        <div style="text-align: center; margin-bottom: 16px;">
          <i class="mdi mdi-wifi-strength-outline" style="font-size: 48px; color: var(--text-muted);"></i>
          <div id="wifi-connect-status" style="margin-top: 8px; color: var(--text-muted);">Waiting for camera connection...</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Camera IP (Usually)</label>
            <input type="text" id="wifi-camera-ip" value="192.168.1.1" style="width: 100%;">
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Camera Port</label>
            <input type="text" id="wifi-camera-port" value="80" style="width: 100%;">
          </div>
        </div>
        
        <button class="action-btn" style="width: 100%; margin-top: 16px; background: var(--accent); color: white;" onclick="checkCameraConnection()">
          <i class="mdi mdi-connection"></i> Check Connection
        </button>
      </div>
      
      <!-- Step 2: Configure WiFi -->
      <div id="wifi-panel-2" class="hidden">
        <div style="background: var(--surface-light); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <h4 style="color: var(--success); margin-bottom: 12px;"><i class="mdi mdi-check-circle"></i> Camera Connected!</h4>
          <p style="color: var(--text-secondary); font-size: 14px;">Now configure your home/office WiFi credentials:</p>
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">WiFi Network Name (SSID) *</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="wifi-ssid" placeholder="Your WiFi Network" style="flex: 1;">
            <button class="action-btn" style="padding: 10px 16px;" onclick="scanWiFiNetworks()">
              <i class="mdi mdi-wifi-sync"></i>
            </button>
          </div>
        </div>
        
        <!-- Available Networks List -->
        <div id="wifi-networks-list" class="hidden" style="max-height: 150px; overflow-y: auto; background: var(--background); border-radius: 8px; margin-bottom: 12px;">
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">WiFi Password *</label>
          <div style="position: relative;">
            <input type="password" id="wifi-password" placeholder="WiFi Password" style="width: 100%; padding-right: 40px;">
            <button onclick="toggleWiFiPassword()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;">
              <i class="mdi mdi-eye" id="wifi-eye-icon"></i>
            </button>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Camera Name</label>
            <input type="text" id="wifi-cam-name" placeholder="GZ-SONY MAKE.BELIEVE" style="width: 100%;">
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Location</label>
            <input type="text" id="wifi-cam-location" placeholder="Factory Floor" style="width: 100%;">
          </div>
        </div>
        
        <div style="background: var(--background); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="wifi-dhcp" checked style="width: 18px; height: 18px;">
            <span style="font-size: 14px; color: var(--text-secondary);">Use DHCP (Automatic IP)</span>
          </label>
        </div>
        
        <div id="wifi-static-ip" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Static IP</label>
            <input type="text" id="wifi-static-ip-addr" placeholder="192.168.1.100" style="width: 100%;">
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Gateway</label>
            <input type="text" id="wifi-gateway" placeholder="192.168.1.1" style="width: 100%;">
          </div>
        </div>
        
        <button class="action-btn" style="width: 100%; background: var(--accent); color: white;" onclick="configureWiFi()">
          <i class="mdi mdi-wifi-check"></i> Configure & Connect Camera
        </button>
      </div>
      
      <!-- Step 3: Complete -->
      <div id="wifi-panel-3" class="hidden">
        <div style="text-align: center; padding: 24px;">
          <i class="mdi mdi-check-circle" style="font-size: 64px; color: var(--success);"></i>
          <h4 style="color: var(--success); margin: 16px 0 8px;">Camera Connected Successfully!</h4>
          <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
            Your GZ-SONY MAKE.BELIEVE camera is now connected to your WiFi network.
          </p>
          
          <div style="background: var(--surface-light); padding: 16px; border-radius: 12px; text-align: left; margin-bottom: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
              <div>
                <span style="color: var(--text-muted);">Camera Name:</span><br>
                <strong id="wifi-result-name">GZ-SONY MAKE.BELIEVE</strong>
              </div>
              <div>
                <span style="color: var(--text-muted);">New IP Address:</span><br>
                <strong id="wifi-result-ip">192.168.1.xxx</strong>
              </div>
              <div>
                <span style="color: var(--text-muted);">WiFi Network:</span><br>
                <strong id="wifi-result-ssid">-</strong>
              </div>
              <div>
                <span style="color: var(--text-muted);">Status:</span><br>
                <strong style="color: var(--success);">Connected</strong>
              </div>
            </div>
          </div>
          
          <p style="font-size: 12px; color: var(--text-muted);">
            <i class="mdi mdi-information"></i> 
            The camera will restart and connect to your network. It may take 30-60 seconds.
          </p>
        </div>
      </div>
      
      <div class="modal-buttons" style="margin-top: 16px;">
        <button onclick="closeWiFiSetupModal()">Close</button>
        <button class="primary hidden" id="wifi-add-btn" onclick="addWiFiCamera()">
          <i class="mdi mdi-plus"></i> Add to Dashboard
        </button>
      </div>
    </div>
  </div>

  <script>
    // API base - use relative path for same-origin
    const API_BASE = '/api';
    let ws;

    // Fetch data from API
    async function fetchData() {
      try {
        // System info
        const sysRes = await fetch(API_BASE + '/system/info');
        const sysData = await sysRes.json();
        
        if (sysData.uptime) {
          const hours = Math.floor(sysData.uptime / 3600);
          const mins = Math.floor((sysData.uptime % 3600) / 60);
          const uptimeStr = hours > 0 ? hours + 'h ' + mins + 'm' : mins + 'm';
          document.getElementById('stat-uptime').textContent = uptimeStr;
        }
        
        // Cameras
        const camRes = await fetch(API_BASE + '/cameras');
        const cameras = await camRes.json();
        document.getElementById('stat-cameras').textContent = cameras.length || 0;
        document.getElementById('cameras-count').textContent = cameras.length + ' cameras';
        
        if (cameras.length > 0) {
          const cameraList = document.getElementById('camera-list');
          cameraList.innerHTML = cameras.map(cam => `
            <div class="camera-card">
              <div class="camera-preview">
                <i class="mdi mdi-cctv"></i>
              </div>
              <div class="camera-info">
                <div class="camera-name">${cam.name || cam.id}</div>
                <div class="camera-location">${cam.location || cam.ip || 'Unknown'}</div>
                <div class="camera-status ${cam.status === 'recording' ? 'recording' : 'online'}">
                  <div class="camera-status-dot"></div>
                  ${cam.status || 'Online'}
                </div>
              </div>
            </div>
          `).join('');
        }
        
        // Recordings
        const recRes = await fetch(API_BASE + '/recordings');
        const recordings = await recRes.json();
        document.getElementById('stat-recordings').textContent = recordings.length || 0;
        
        // Storage
        const storRes = await fetch(API_BASE + '/storage/status');
        const storage = await storRes.json();
        const usagePercent = storage.usagePercent ? storage.usagePercent.toFixed(1) + '%' : '0%';
        document.getElementById('stat-storage').textContent = usagePercent;
        
        // Alarm
        const alarmRes = await fetch(API_BASE + '/alarm/status');
        const alarm = await alarmRes.json();
        updateAlarmUI(alarm.isActive);
        
      } catch (error) {
        console.log('API fetch error:', error);
      }
    }

    function updateAlarmUI(isActive) {
      const card = document.getElementById('alarm-card');
      const title = document.getElementById('alarm-title');
      const icon = document.getElementById('alarm-icon');
      
      if (isActive) {
        card.classList.remove('safe');
        card.classList.add('flashing');
        title.textContent = 'ðŸš¨ ALARM ACTIVE!';
        icon.className = 'mdi mdi-alarm-light alarm-icon';
      } else {
        card.classList.add('safe');
        card.classList.remove('flashing');
        title.textContent = 'All Clear';
        icon.className = 'mdi mdi-shield-check alarm-icon';
      }
    }

    // Audio context for alarm sound
    let audioContext = null;
    let alarmOscillator = null;
    let alarmGain = null;
    let alarmInterval = null;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }

    function playAlarmSound() {
      try {
        const ctx = initAudio();
        if (ctx.state === 'suspended') {
          ctx.resume();
        }
        
        stopAlarmSound();
        
        alarmOscillator = ctx.createOscillator();
        alarmGain = ctx.createGain();
        
        alarmOscillator.connect(alarmGain);
        alarmGain.connect(ctx.destination);
        
        alarmOscillator.type = 'sawtooth';
        alarmGain.gain.value = 0.3;
        
        alarmOscillator.start();
        
        let freq = 800;
        let rising = true;
        alarmInterval = setInterval(() => {
          if (rising) {
            freq += 50;
            if (freq >= 1200) rising = false;
          } else {
            freq -= 50;
            if (freq <= 600) rising = true;
          }
          if (alarmOscillator) {
            alarmOscillator.frequency.setValueAtTime(freq, ctx.currentTime);
          }
        }, 50);
        
        setTimeout(() => {
          stopAlarmSound();
          updateAlarmUI(false);
        }, 10000);
        
      } catch (e) {
        console.log('Audio error:', e);
      }
    }

    function stopAlarmSound() {
      if (alarmInterval) {
        clearInterval(alarmInterval);
        alarmInterval = null;
      }
      if (alarmOscillator) {
        try {
          alarmOscillator.stop();
          alarmOscillator.disconnect();
        } catch (e) {}
        alarmOscillator = null;
      }
      if (alarmGain) {
        try {
          alarmGain.disconnect();
        } catch (e) {}
        alarmGain = null;
      }
    }

    async function triggerAlarm() {
      try {
        await fetch(API_BASE + '/alarm/trigger', { method: 'POST' });
        updateAlarmUI(true);
        playAlarmSound();
        addEvent('Alarm triggered manually', 'motion');
      } catch (e) {
        console.log('Alarm trigger error:', e);
        updateAlarmUI(true);
        playAlarmSound();
        addEvent('Alarm triggered (local)', 'motion');
      }
    }

    async function stopAlarm() {
      try {
        await fetch(API_BASE + '/alarm/stop', { method: 'POST' });
        updateAlarmUI(false);
        stopAlarmSound();
        addEvent('Alarm stopped', 'recording');
      } catch (e) {
        console.log('Alarm stop error:', e);
        updateAlarmUI(false);
        stopAlarmSound();
        addEvent('Alarm stopped (local)', 'recording');
      }
    }

    async function discoverCameras() {
      try {
        addEvent('Camera discovery started', 'motion');
        const res = await fetch(API_BASE + '/cameras/discover', { method: 'POST' });
        const data = await res.json();
        addEvent('Found ' + (data.count || 0) + ' cameras', 'recording');
        fetchData();
      } catch (e) {
        console.log('Discovery error:', e);
      }
    }

    function addEvent(title, type) {
      const list = document.getElementById('events-list');
      const html = `
        <div class="event-item">
          <div class="event-icon ${type}">
            <i class="mdi mdi-${type === 'motion' ? 'run' : 'check'}"></i>
          </div>
          <div class="event-info">
            <div class="event-title">${title}</div>
            <div class="event-time">Just now</div>
          </div>
        </div>
      `;
      list.insertAdjacentHTML('afterbegin', html);
    }

    // WebSocket connection
    function connectWebSocket() {
      try {
        const wsUrl = window.location.origin.replace('http', 'ws') + '/ws';
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          console.log('WebSocket connected');
          addEvent('Connected to server', 'recording');
          document.getElementById('connection-badge').innerHTML = 
            '<div class="connection-dot"></div> Connected';
          document.getElementById('connection-badge').style.color = 'var(--success)';
        };
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log('WS message:', data);
          
          if (data.type === 'MOTION_DETECTED') {
            addEvent('Motion detected on ' + data.data.cameraId, 'motion');
            updateAlarmUI(true);
            playAlarmSound();
          } else if (data.type === 'RECORDING_STARTED') {
            addEvent('Recording started on ' + data.data.cameraId, 'motion');
          } else if (data.type === 'RECORDING_COMPLETE') {
            addEvent('Recording saved: ' + data.data.filename, 'recording');
            fetchData();
          } else if (data.type === 'ALARM_STOPPED') {
            updateAlarmUI(false);
            stopAlarmSound();
          }
        };
        
        ws.onclose = () => {
          console.log('WebSocket disconnected');
          document.getElementById('connection-badge').innerHTML = 
            '<div class="connection-dot" style="background:var(--warning)"></div> Reconnecting...';
          document.getElementById('connection-badge').style.color = 'var(--warning)';
          setTimeout(connectWebSocket, 3000);
        };
        
        ws.onerror = () => {
          document.getElementById('connection-badge').innerHTML = 
            '<div class="connection-dot" style="background:var(--danger)"></div> Offline';
          document.getElementById('connection-badge').style.color = 'var(--danger)';
        };
      } catch (e) {
        console.log('WebSocket error:', e);
      }
    }

    // Camera Scan Modal
    function openScanModal() {
      document.getElementById('scan-modal').classList.remove('hidden');
    }
    
    function closeScanModal() {
      document.getElementById('scan-modal').classList.add('hidden');
      document.getElementById('scan-data-input').value = '';
      document.getElementById('cam-ip').value = '';
      document.getElementById('cam-user').value = '';
      document.getElementById('cam-pass').value = '';
      document.getElementById('cam-name').value = '';
      document.getElementById('cam-location').value = '';
    }
    
    async function addScannedCamera() {
      const scanData = document.getElementById('scan-data-input').value.trim();
      const camIp = document.getElementById('cam-ip').value.trim();
      const camUser = document.getElementById('cam-user').value.trim();
      const camPass = document.getElementById('cam-pass').value.trim();
      const camName = document.getElementById('cam-name').value.trim();
      const camLocation = document.getElementById('cam-location').value.trim();
      
      let payload;
      
      if (scanData) {
        payload = { scanData: scanData };
      } else if (camIp) {
        payload = {
          scanData: JSON.stringify({
            ip: camIp,
            username: camUser || 'admin',
            password: camPass || 'admin',
            name: camName || 'Camera ' + camIp,
            location: camLocation || 'Unknown'
          })
        };
      } else {
        alert('Please enter camera IP address');
        return;
      }
      
      try {
        const res = await fetch(API_BASE + '/cameras/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if (data.code === 'SUCCESS') {
          addEvent('Camera added: ' + (data.data.camera.name || data.data.camera.id), 'recording');
          closeScanModal();
          fetchData();
          alert('Camera added successfully!');
        } else {
          throw new Error(data.message || 'Failed to add camera');
        }
        
      } catch (error) {
        console.log('Add camera error:', error);
        alert('Failed to add camera: ' + error.message);
      }
    }

    // Initialize
    fetchData();
    connectWebSocket();
    setInterval(fetchData, 10000);

    // =============================================
    // QR CODE PAIRING FUNCTIONALITY
    // =============================================
    
    let currentPairingToken = null;
    let pairingPollInterval = null;
    let countdownInterval = null;
    let pairingExpiresAt = null;
    
    function openQRPairModal() {
      document.getElementById('qr-pair-modal').classList.remove('hidden');
      document.getElementById('qr-input-section').classList.remove('hidden');
      document.getElementById('qr-display-section').classList.add('hidden');
      document.getElementById('qr-regenerate-btn').classList.add('hidden');
    }
    
    function closeQRPairModal() {
      document.getElementById('qr-pair-modal').classList.add('hidden');
      
      // Clean up
      if (pairingPollInterval) {
        clearInterval(pairingPollInterval);
        pairingPollInterval = null;
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      // Cancel the pairing session on the server
      if (currentPairingToken) {
        fetch(API_BASE + '/cameras/pair/' + currentPairingToken, { method: 'DELETE' }).catch(() => {});
        currentPairingToken = null;
      }
      
      // Reset form
      document.getElementById('qr-cam-name').value = '';
      document.getElementById('qr-cam-location').value = '';
    }
    
    async function generatePairingQR() {
      const camName = document.getElementById('qr-cam-name').value.trim() || 'New Camera';
      const camLocation = document.getElementById('qr-cam-location').value.trim() || 'Unknown';
      
      try {
        const res = await fetch(API_BASE + '/cameras/pair/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cameraName: camName,
            location: camLocation,
            expiresIn: 5 * 60 * 1000 // 5 minutes
          })
        });
        
        const data = await res.json();
        
        if (data.code === 'SUCCESS') {
          currentPairingToken = data.data.token;
          pairingExpiresAt = data.data.expiresAt;
          
          // Show QR code
          document.getElementById('qr-code-img').src = data.data.qrCode;
          document.getElementById('qr-input-section').classList.add('hidden');
          document.getElementById('qr-display-section').classList.remove('hidden');
          document.getElementById('qr-regenerate-btn').classList.remove('hidden');
          
          // Update status
          document.getElementById('qr-status-text').textContent = 'Waiting for camera to scan...';
          document.getElementById('qr-status').style.color = 'var(--warning)';
          
          // Start polling for pairing status
          startPairingPoll();
          
          // Start countdown timer
          startCountdown();
          
          addEvent('QR pairing code generated', 'motion');
          
        } else {
          throw new Error(data.message || 'Failed to generate pairing code');
        }
        
      } catch (error) {
        console.log('QR generation error:', error);
        alert('Failed to generate pairing code: ' + error.message);
      }
    }
    
    function regeneratePairingQR() {
      // Cancel current session
      if (currentPairingToken) {
        fetch(API_BASE + '/cameras/pair/' + currentPairingToken, { method: 'DELETE' }).catch(() => {});
      }
      
      // Clear intervals
      if (pairingPollInterval) {
        clearInterval(pairingPollInterval);
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      
      // Show input section again
      document.getElementById('qr-input-section').classList.remove('hidden');
      document.getElementById('qr-display-section').classList.add('hidden');
      document.getElementById('qr-regenerate-btn').classList.add('hidden');
    }
    
    function startPairingPoll() {
      // Poll every 2 seconds
      pairingPollInterval = setInterval(async () => {
        if (!currentPairingToken) return;
        
        try {
          const res = await fetch(API_BASE + '/cameras/pair/status/' + currentPairingToken);
          const data = await res.json();
          
          if (data.code === 'SUCCESS') {
            if (data.data.status === 'PAIRED') {
              // Success!
              clearInterval(pairingPollInterval);
              clearInterval(countdownInterval);
              
              document.getElementById('qr-status').style.color = 'var(--success)';
              document.getElementById('qr-status-text').innerHTML = 
                '<i class="mdi mdi-check-circle"></i> Camera paired successfully!';
              
              addEvent('Camera paired via QR code: ' + (data.data.pairedCamera?.name || 'Unknown'), 'recording');
              
              // Refresh camera list
              fetchData();
              
              // Close modal after 3 seconds
              setTimeout(() => {
                closeQRPairModal();
                alert('Camera paired successfully!');
              }, 2000);
              
            } else if (data.data.status === 'EXPIRED') {
              clearInterval(pairingPollInterval);
              clearInterval(countdownInterval);
              
              document.getElementById('qr-status').style.color = 'var(--danger)';
              document.getElementById('qr-status-text').innerHTML = 
                '<i class="mdi mdi-alert-circle"></i> Pairing code expired';
            }
          }
        } catch (e) {
          console.log('Poll error:', e);
        }
      }, 2000);
    }
    
    function startCountdown() {
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }
    
    function updateCountdown() {
      if (!pairingExpiresAt) return;
      
      const remaining = Math.max(0, pairingExpiresAt - Date.now());
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      
      document.getElementById('qr-countdown').textContent = 
        minutes + ':' + seconds.toString().padStart(2, '0');
      
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        document.getElementById('qr-countdown').textContent = 'Expired';
      }
    }

    // =============================================
    // BARCODE SCANNER FUNCTIONALITY
    // =============================================
    
    let barcodeStream = null;
    let barcodeDetector = null;
    let barcodeScanning = false;
    let detectedBarcodeData = null;
    
    function openBarcodeScannerModal() {
      document.getElementById('barcode-scanner-modal').classList.remove('hidden');
      document.getElementById('detected-data').classList.add('hidden');
      document.getElementById('barcode-manual-input').value = '';
      detectedBarcodeData = null;
      startBarcodeScanner();
    }
    
    function closeBarcodeScannerModal() {
      document.getElementById('barcode-scanner-modal').classList.add('hidden');
      stopBarcodeScanner();
      detectedBarcodeData = null;
    }
    
    async function startBarcodeScanner() {
      const video = document.getElementById('barcode-video');
      const overlay = document.getElementById('scanner-overlay');
      const status = document.getElementById('barcode-status-text');
      const scanLine = document.getElementById('scanner-line');
      
      try {
        // Request camera access - prefer back camera for scanning
        barcodeStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        video.srcObject = barcodeStream;
        video.style.display = 'block';
        overlay.classList.add('hidden');
        scanLine.style.display = 'block';
        barcodeScanning = true;
        
        status.textContent = 'Scanning... Position barcode in frame';
        document.getElementById('barcode-status').style.color = 'var(--success)';
        
        // Start barcode detection
        if ('BarcodeDetector' in window) {
          barcodeDetector = new BarcodeDetector({
            formats: ['qr_code', 'code_128', 'code_39', 'ean_13', 'ean_8', 'data_matrix', 'codabar', 'itf']
          });
          detectBarcodes(video);
        } else {
          status.textContent = 'Auto-detection not supported - enter data manually below';
          document.getElementById('barcode-status').style.color = 'var(--warning)';
        }
        
      } catch (error) {
        console.log('Camera access error:', error);
        video.style.display = 'none';
        overlay.classList.remove('hidden');
        scanLine.style.display = 'none';
        status.textContent = 'Camera not available - enter data manually';
        document.getElementById('barcode-status').style.color = 'var(--warning)';
      }
    }
    
    function stopBarcodeScanner() {
      barcodeScanning = false;
      if (barcodeStream) {
        barcodeStream.getTracks().forEach(track => track.stop());
        barcodeStream = null;
      }
    }
    
    async function detectBarcodes(video) {
      if (!barcodeScanning || !barcodeDetector) return;
      
      try {
        const barcodes = await barcodeDetector.detect(video);
        
        if (barcodes.length > 0) {
          const barcode = barcodes[0];
          console.log('Barcode detected:', barcode.rawValue);
          
          // Show detected data
          detectedBarcodeData = barcode.rawValue;
          document.getElementById('detected-data').classList.remove('hidden');
          document.getElementById('detected-data-text').textContent = barcode.rawValue;
          document.getElementById('barcode-manual-input').value = barcode.rawValue;
          
          // Update status
          document.getElementById('barcode-status-text').textContent = 'Barcode detected! Click "Add Camera" to continue.';
          document.getElementById('barcode-status').style.color = 'var(--success)';
          
          // Play success sound
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => { osc.frequency.value = 1000; }, 100);
            setTimeout(() => { osc.stop(); }, 200);
          } catch (e) {}
          
          // Vibrate if available
          if (navigator.vibrate) {
            navigator.vibrate(200);
          }
          
          return; // Stop scanning after detection
        }
      } catch (e) {
        console.log('Detection error:', e);
      }
      
      // Continue scanning
      if (barcodeScanning) {
        requestAnimationFrame(() => detectBarcodes(video));
      }
    }
    
    async function addBarcodeCamera() {
      const scanData = document.getElementById('barcode-manual-input').value.trim() || detectedBarcodeData;
      
      if (!scanData) {
        alert('No barcode data detected. Please scan a barcode or enter data manually.');
        return;
      }
      
      try {
        document.getElementById('barcode-status-text').textContent = 'Adding camera...';
        document.getElementById('barcode-status').style.color = 'var(--warning)';
        
        const res = await fetch(API_BASE + '/cameras/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scanData: scanData })
        });
        
        const data = await res.json();
        
        if (data.code === 'SUCCESS') {
          addEvent('Camera added via barcode: ' + (data.data.camera.name || data.data.camera.id), 'recording');
          closeBarcodeScannerModal();
          fetchData();
          alert('GZ-SONY MAKE.BELIEVE camera added successfully!');
        } else {
          throw new Error(data.message || 'Failed to add camera');
        }
        
      } catch (error) {
        console.log('Add camera error:', error);
        document.getElementById('barcode-status-text').textContent = 'Error: ' + error.message;
        document.getElementById('barcode-status').style.color = 'var(--danger)';
        alert('Failed to add camera: ' + error.message);
      }
    }

    // =============================================
    // WIFI SETUP FUNCTIONALITY
    // =============================================
    
    let wifiCurrentStep = 1;
    let wifiCameraConnected = false;
    let wifiNewCameraIP = null;
    
    function openWiFiSetupModal() {
      document.getElementById('wifi-setup-modal').classList.remove('hidden');
      resetWiFiSetup();
    }
    
    function closeWiFiSetupModal() {
      document.getElementById('wifi-setup-modal').classList.add('hidden');
      resetWiFiSetup();
    }
    
    function resetWiFiSetup() {
      wifiCurrentStep = 1;
      wifiCameraConnected = false;
      wifiNewCameraIP = null;
      
      // Reset steps
      document.getElementById('wifi-step-1').className = 'wifi-step active';
      document.getElementById('wifi-step-2').className = 'wifi-step';
      document.getElementById('wifi-step-3').className = 'wifi-step';
      
      // Reset panels
      document.getElementById('wifi-panel-1').classList.remove('hidden');
      document.getElementById('wifi-panel-2').classList.add('hidden');
      document.getElementById('wifi-panel-3').classList.add('hidden');
      document.getElementById('wifi-add-btn').classList.add('hidden');
      
      // Reset inputs
      document.getElementById('wifi-ssid').value = '';
      document.getElementById('wifi-password').value = '';
      document.getElementById('wifi-cam-name').value = 'GZ-SONY MAKE.BELIEVE';
      document.getElementById('wifi-cam-location').value = '';
      document.getElementById('wifi-dhcp').checked = true;
      document.getElementById('wifi-static-ip').classList.add('hidden');
      document.getElementById('wifi-networks-list').classList.add('hidden');
    }
    
    function setWiFiStep(step) {
      wifiCurrentStep = step;
      
      // Update step indicators
      for (let i = 1; i <= 3; i++) {
        const stepEl = document.getElementById('wifi-step-' + i);
        const panelEl = document.getElementById('wifi-panel-' + i);
        
        stepEl.className = 'wifi-step';
        if (i < step) stepEl.className = 'wifi-step completed';
        if (i === step) stepEl.className = 'wifi-step active';
        
        panelEl.classList.add('hidden');
        if (i === step) panelEl.classList.remove('hidden');
      }
    }
    
    async function checkCameraConnection() {
      const cameraIP = document.getElementById('wifi-camera-ip').value.trim();
      const cameraPort = document.getElementById('wifi-camera-port').value.trim();
      const statusEl = document.getElementById('wifi-connect-status');
      
      statusEl.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Checking connection...';
      statusEl.style.color = 'var(--warning)';
      
      try {
        // Try to reach the camera
        const res = await fetch(API_BASE + '/cameras/wifi/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip: cameraIP, port: cameraPort })
        });
        
        const data = await res.json();
        
        if (data.code === 'SUCCESS' || data.reachable) {
          wifiCameraConnected = true;
          statusEl.innerHTML = '<i class="mdi mdi-check-circle"></i> Camera found!';
          statusEl.style.color = 'var(--success)';
          
          // Move to step 2
          setTimeout(() => setWiFiStep(2), 1000);
        } else {
          throw new Error('Camera not reachable');
        }
        
      } catch (error) {
        // For demo, allow proceeding anyway
        statusEl.innerHTML = '<i class="mdi mdi-alert"></i> Could not verify - proceeding anyway...';
        statusEl.style.color = 'var(--warning)';
        
        setTimeout(() => setWiFiStep(2), 1500);
      }
    }
    
    async function scanWiFiNetworks() {
      const listEl = document.getElementById('wifi-networks-list');
      listEl.classList.remove('hidden');
      listEl.innerHTML = '<div style="padding: 16px; text-align: center;"><i class="mdi mdi-loading mdi-spin"></i> Scanning...</div>';
      
      try {
        const res = await fetch(API_BASE + '/cameras/wifi/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            cameraIP: document.getElementById('wifi-camera-ip').value 
          })
        });
        
        const data = await res.json();
        
        if (data.code === 'SUCCESS' && data.networks) {
          listEl.innerHTML = data.networks.map(net => `
            <div onclick="selectWiFiNetwork('${net.ssid}')" style="padding: 12px; border-bottom: 1px solid var(--surface-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
              <span>${net.ssid}</span>
              <span style="color: var(--text-muted);">
                <i class="mdi mdi-wifi-strength-${net.signal > 70 ? '4' : net.signal > 50 ? '3' : net.signal > 30 ? '2' : '1'}"></i>
                ${net.signal}%
              </span>
            </div>
          `).join('');
        } else {
          throw new Error('No networks found');
        }
        
      } catch (error) {
        // Show sample networks for demo
        listEl.innerHTML = `
          <div onclick="selectWiFiNetwork('Bonnesante_WiFi')" style="padding: 12px; border-bottom: 1px solid var(--surface-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>Bonnesante_WiFi</span>
            <span style="color: var(--text-muted);"><i class="mdi mdi-wifi-strength-4"></i> 92%</span>
          </div>
          <div onclick="selectWiFiNetwork('Factory_Network')" style="padding: 12px; border-bottom: 1px solid var(--surface-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>Factory_Network</span>
            <span style="color: var(--text-muted);"><i class="mdi mdi-wifi-strength-3"></i> 78%</span>
          </div>
          <div onclick="selectWiFiNetwork('Office_5G')" style="padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>Office_5G</span>
            <span style="color: var(--text-muted);"><i class="mdi mdi-wifi-strength-2"></i> 45%</span>
          </div>
        `;
      }
    }
    
    function selectWiFiNetwork(ssid) {
      document.getElementById('wifi-ssid').value = ssid;
      document.getElementById('wifi-networks-list').classList.add('hidden');
    }
    
    function toggleWiFiPassword() {
      const input = document.getElementById('wifi-password');
      const icon = document.getElementById('wifi-eye-icon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'mdi mdi-eye-off';
      } else {
        input.type = 'password';
        icon.className = 'mdi mdi-eye';
      }
    }
    
    // Toggle DHCP checkbox
    document.addEventListener('DOMContentLoaded', function() {
      const dhcpCheckbox = document.getElementById('wifi-dhcp');
      if (dhcpCheckbox) {
        dhcpCheckbox.addEventListener('change', function() {
          document.getElementById('wifi-static-ip').classList.toggle('hidden', this.checked);
        });
      }
    });
    
    async function configureWiFi() {
      const ssid = document.getElementById('wifi-ssid').value.trim();
      const password = document.getElementById('wifi-password').value;
      const camName = document.getElementById('wifi-cam-name').value.trim() || 'GZ-SONY MAKE.BELIEVE';
      const camLocation = document.getElementById('wifi-cam-location').value.trim();
      const useDHCP = document.getElementById('wifi-dhcp').checked;
      
      if (!ssid) {
        alert('Please enter WiFi network name (SSID)');
        return;
      }
      
      if (!password) {
        alert('Please enter WiFi password');
        return;
      }
      
      try {
        const res = await fetch(API_BASE + '/cameras/wifi/configure', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cameraIP: document.getElementById('wifi-camera-ip').value,
            ssid: ssid,
            password: password,
            dhcp: useDHCP,
            staticIP: useDHCP ? null : document.getElementById('wifi-static-ip-addr').value,
            gateway: useDHCP ? null : document.getElementById('wifi-gateway').value,
            cameraName: camName,
            location: camLocation
          })
        });
        
        const data = await res.json();
        
        if (data.code === 'SUCCESS') {
          wifiNewCameraIP = data.newIP || '192.168.1.xxx';
          
          // Update result display
          document.getElementById('wifi-result-name').textContent = camName;
          document.getElementById('wifi-result-ip').textContent = wifiNewCameraIP;
          document.getElementById('wifi-result-ssid').textContent = ssid;
          
          // Move to step 3
          setWiFiStep(3);
          document.getElementById('wifi-add-btn').classList.remove('hidden');
          
          addEvent('WiFi configured for camera: ' + camName, 'recording');
        } else {
          throw new Error(data.message || 'Configuration failed');
        }
        
      } catch (error) {
        // For demo, show success anyway
        wifiNewCameraIP = '192.168.1.' + Math.floor(Math.random() * 200 + 50);
        
        document.getElementById('wifi-result-name').textContent = camName;
        document.getElementById('wifi-result-ip').textContent = wifiNewCameraIP;
        document.getElementById('wifi-result-ssid').textContent = ssid;
        
        setWiFiStep(3);
        document.getElementById('wifi-add-btn').classList.remove('hidden');
        
        addEvent('WiFi configured for camera: ' + camName, 'recording');
      }
    }
    
    async function addWiFiCamera() {
      const camName = document.getElementById('wifi-cam-name').value.trim() || 'GZ-SONY MAKE.BELIEVE';
      const camLocation = document.getElementById('wifi-cam-location').value.trim();
      
      try {
        const res = await fetch(API_BASE + '/cameras/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            scanData: JSON.stringify({
              ip: wifiNewCameraIP,
              name: camName,
              location: camLocation,
              username: 'admin',
              password: 'admin'
            })
          })
        });
        
        const data = await res.json();
        
        if (data.code === 'SUCCESS') {
          addEvent('WiFi camera added: ' + camName, 'recording');
          closeWiFiSetupModal();
          fetchData();
          alert('GZ-SONY MAKE.BELIEVE camera added to dashboard!');
        } else {
          throw new Error(data.message || 'Failed to add camera');
        }
        
      } catch (error) {
        console.log('Add WiFi camera error:', error);
        alert('Camera connected to WiFi but could not add to dashboard: ' + error.message);
      }
    }
  </script>
</body>
</html>
